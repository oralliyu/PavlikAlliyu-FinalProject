---
author: Funke Alliyu and Lauryn Pavlik
date: April 30th, 2019
title: "Stat 380 Final Project"
output: html_notebook
---


```{r}
# Clean up environment
rm(list = ls())

# Load packages
library(tidyverse)
library(readr)
library(utils)

# Add data 
raw_fed_data <- 
  read_csv("dif source join.csv")
NCANDS <- 
  read_csv("Findings from NCANDS - Data Tables (updated with FY 2015).csv")


```

# Data Table One

```{r}
# View fed data
head(raw_fed_data)

```
This data set was found on data.gov.

# Data Table Two

```{r}
# View NCANDS data
head(NCANDS)

```
This data is from https://www.acf.hhs.gov/cb/resource/child-maltreatment-2014-data-tables.


## Cleaning Federal Data

### Making a totals table 

```{r}
# Make totals seperate table from fed_data
fed_totals <-
  raw_fed_data %>%
  filter(`Measure 2` == "Total")

```

```{r}
# Clean fed_totals
fed_totals <- 
  fed_totals %>%
  rename(Measure_2 = 'Measure 2',  Measure_1 = 'Measure 1') %>%
  spread(key = Format, value = Value) 

```

```{r}
# Remove columns
fed_totals <- 
  fed_totals %>%
  select(-'X7', -'Measure_1', -'Measure_2')

```

```{r}
# Rename remaining variables
fed_totals <- 
  fed_totals %>%
  rename(Num_fatalities = 'Number', Rate_per_100000 = 'Rate per 100,000 Children')

```

Here we have created a table containing the total number of child abuse fatalities from each state and the child fatality rate per 100,000 children. It is important to note that data for Maine and Massachusetts were not provided, but data for Puerto Rico and the District of Columbia were provided making the total number of cases 50. 

### Cleaning original table

```{r}
# Rename and spread
fed_data <- 
  raw_fed_data %>%
  rename(Measure_2 = 'Measure 2',  Measure_1 = 'Measure 1') %>%
  spread(key = Measure_2, value = Value) %>%
  spread(key = Format, value = Total) %>%
  select(-`Rate per 100,000 Children`, -`X7`)      # Remove unimportant rows for analysis

```

```{r}
# Remove rows 
fed_data <- 
  fed_data[-c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
              42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78,
              80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100), ]  # Remove even rows with all N/As

```

```{r}
# Finish cleaning
fed_data[is.na(fed_data)] = 0     # Set useful N/As to zero

fed_data <- 
  fed_data %>%
  rename(Num_agencyfile = `Reported in the Agency File`, 
         Num_childfile = `Reported in the Child File`, 
         Total = Number) %>%
  select(-`Measure_1`)
  
  
```

```{r}
# Add rates
fed_data <-
  full_join(fed_data, fed_totals) %>%    # Join to add rates column into new table
  select(-Total)

fed_data <- 
  fed_data %>%
  mutate(State_num = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
                       19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
                       35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50)) # Add number labels to cases for easier graph visualization
  
```
Here, we have made a table of 50 cases (same issues with states as fed_totals table) and included the variables pertaining to the number of child abuse cases that went into differing files, total number of fatalities, and the rate of child abuse fatalities per 100,0000 children. Again, even rows were removed due to a containment of excessive N/As. The remaining N/As were set to zero because they were in the files column. With observation, one can see that if you add the number of Num_agencyfile and Num_childfile for that row, that sum is the Num_fatalities column. We also have assigned a number to label each case because it will make graph visualizations in the future easier to understand. 


## Cleaning NCANDS Data By Breaking Down Tables

```{r}
# Rename to make spreading easier
NCANDS <-
  NCANDS %>%
  rename(Characteristic = `Characteristic Label`)

```
In the following chunks of code, we will be filtering the different tables out of the enormous NCANDS data to clean all the tables and make them tidy. Each table has a title describing the contents of it. Each of these tables all revolve around the topic of child abuse.


### Make fatality_sub_type

```{r}
# Table for child abuse fatalities by their submission type
fatality_sub_type <-
  NCANDS %>%
  filter(Table == "Child Fatalities by Submission Type") %>% # Filter to receive desired table
  select(- "Measure") %>%
  spread(key = Characteristic, value = Value) %>%
  spread(key = Format, value = Total) %>%
  select(-Rate)

fatality_sub_type <- 
  fatality_sub_type[-c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
              42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78,
              80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100), ]  # Remove N/As

fatality_sub_type[is.na(fatality_sub_type)] = 0

fatality_sub_type <- 
  fatality_sub_type %>%
  rename(Num_agencyfile = `Reported in the Agency File`,
         Num_childfile = `Reported in the Child File`)

```

### Make fatality_trend

```{r} 
# Table to show the trends of child abuse fatalities
fatality_trend <-
  NCANDS %>%
  filter(Table == "Child Fatalities, Trend") %>%   # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  spread(key = Year, value = `Child fatalities`) %>%
  select(- Characteristic, - Format)

```

### Make victim_age

```{r}
# Table to show the victims' ages 
victim_age <-
  NCANDS %>%
  filter(Table == "Child Victims by Age") %>%    # Filter to receive desired table
  spread(key = Characteristic, value = Value)

victim_age <- 
  victim_age[-c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
              42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78,
              80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106), ]

# Remove rows that do not have a match in other tables 
victim_age <- 
  victim_age[-c(20, 28, 41), ]

victim_age[[24]] <- NULL

victim_age <- 
  victim_age %>%
  select(- Measure) %>%
  rename(Age_under1 = `Age <1`, Age_1 = `Age 1`, Age_10 = `Age 10`, Age_11 = `Age 11`, 
         Age_12 = `Age 12`, Age_13 = `Age 13`, Age_14 = `Age 14`, Age_15 = `Age 15`, 
         Age_16 = `Age 16`, Age_17 = `Age 17`, Age_2 = `Age 2`, Age_3 = `Age 3`, 
         Age_4 = `Age 4`, Age_5 = `Age 5`, Age_6 = `Age 6`, Age_7 = `Age 7`, 
         Age_8 = `Age 8`, Age_9 = `Age 9`)


```

### Make case_type 

```{r}
# Table that shows the different case types and results
case_type <-
  NCANDS %>%
  filter(Table == "Children by Disposition") %>%    # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  select(- `Nonvictims (duplicate count) by disposition`, -Format) %>%
  spread(key = Characteristic, value = `Victims (duplicate count) by disposition`) %>%
  select(- `Alternative Response`, - `Closed With No Finding`, - `Indicated`, 
         - `Intentionally False`, - `No Alleged Maltreatment`, - `Other`, - `Unknown`, 
         - `Unsubstantiated`)
case_type <- 
  case_type[-c(20, 28, 41), ]

```

### Make investigation

```{r}
# Table to show how many cases received an investigation
investigation <-
  NCANDS %>%
  filter(Table == "Children Who Received an Investigation or Alternative Response, Trend") %>%
  spread(key = Measure, value = Value) %>%
  select(- `Children (unique count) who received an investigation or alternative response, rate per 1,000 children`) %>%
  spread(key = Year, 
         value = `Children (unique count) who received an investigation or alternative response`)%>%
  select(- Characteristic, - Format) 

investigation <- 
  investigation[-c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
              42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78,
              80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106), ]

investigation <-
  investigation[-c(20, 28, 41), ]

```

### Make mal_type 

```{r}
# Table to show how many children suffered a specific type of abuse 
mal_type <-
  NCANDS %>%
  filter(Table == "Maltreatment Types of Victims") %>%   # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  spread(key = Characteristic, value = `Victims (unique count) by maltreatment type`)

mal_type <- 
  mal_type[-c(20, 28, 41), ]

mal_type[is.na(mal_type)] = 0  # Change N/As to 0 to represent no data being recorded for that year

mal_type <- 
  mal_type %>%
  rename(Med_neglect = `Medical Neglect`, Physical_abuse = `Physical Abuse`, 
         Psych_abuse = `Psychological Maltreatment`, Sexual_abuse = `Sexual Abuse`) 


```

### Make perpetrator_tally

```{r}
# Table to show the abuser's relationship to the victim
perpetrator_tally <-
  NCANDS %>%
  filter(Table == "Perpetrators by Relationship to their Victims") %>% # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  spread(key = Characteristic,
         value = `Perpetrators (unique count) by relationship to their victims`) %>%
  select(- Format)

perpetrator_tally[is.na(perpetrator_tally)] = 0

perpetrator_tally <- 
  perpetrator_tally %>%
  rename(Daycare_provider = `Child Daycare Provider`, Foster_parent = `Foster Parent`,
         Friend_neighbor = `Friend and Neighbor`, 
         Group_home = `Group Home and Residential Facility Staff`,
         Guardian = `Legal Guardian`, Multiple = `Multiple Relationships`,
         Other_professional = `Other Professional`, 
         Other_relative = `Other Relative`, Unmarried_partner = `Unmarried Partner of Parent`)

```

### Make perpetrator_total

```{r}
# Table to show the amounts of perpetrators known in each year for each case
perpetrator_total <-
  NCANDS %>%
  filter(Table == "Perpetrators, Trend") %>% # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  select(- Format, - Characteristic) %>%
  spread(key = Year, value = `Perpetrators (unique count)`) 

perpetrator_total[is.na(perpetrator_total)] = 0

perpetrator_total <- 
  perpetrator_total[-c(19, 27), ]

```

### Make referral_type

```{r}
# Table to show values for types of referrals
referral_type <-
  NCANDS %>%
  filter(Table == "Screened-In and Screened-Out Referrals") %>% # Filter to receive desired table
  spread(key = Measure, value = Value) %>%
  select(- `Referrals, percent of total`, - `Referrals, rate per 1,000 children`,
         - Format)

referral_type <- 
  referral_type[-c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
              42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78,
              80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114,
              116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146,
              148, 150, 152, 154, 156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 
              180, 182, 184, 186, 188, 190, 192, 194, 196, 198, 200, 202, 204, 206, 208, 210,
              212, 214, 216, 218, 220, 222, 224, 226, 228, 230, 232, 234, 236, 238, 240, 242,
              244, 246, 248, 250, 252, 254, 256, 258, 260, 262, 264, 266, 268, 270, 272, 274,
              276, 278, 280), ]

referral_type<- 
  referral_type %>%
  spread(key = Characteristic, value = Referrals) %>%
  select(- Total)

referral_type[is.na(referral_type)] = 0

referral_type <-
  referral_type %>%
  rename(Screen_in = `Screened-In Referrals (Reports)`, Screen_out = `Screened-Out Referrals`)

referral_type$Total <- referral_type$Screen_in + referral_type$Screen_out # Add a column that shows the total of both types of referrals

```

# Join Tables From Different Sources

```{r}
# Make one big messy table
All_data <-
  fed_data %>%
  full_join( by = "State", case_type) %>%
  full_join(by = "State", fatality_sub_type) %>%
  full_join(by = "State", fatality_trend) %>%
  full_join(by = "State", investigation) %>%
  full_join(by = "State", mal_type) %>%
  full_join(by = "State", perpetrator_tally) %>%
  full_join(by = "State", perpetrator_total) %>%
  full_join(by = "State", referral_type) %>%
  full_join(by = "State", victim_age) 

``` 

```{r}
# Rename variables to keep
All_data <- 
  All_data %>%
  rename(Num_agencyfile2014 = Num_agencyfile.x, Num_childfile2014 = Num_childfile.x, 
         Num_fatalities2014 = Num_fatalities, Rate2014 = Rate_per_100000,
         Substantiated_case = Substantiated, Num_agencyfile2015 = Num_agencyfile.y,
         Num_childfile2015 = Num_childfile.y, Num_fatalities2015 = Number, 
         Num_fatalities2011 = `2011.x`, Num_fatalities2012 = `2012.x`, 
         Num_fatalities2013 = `2013.x`, Invest2011 = `2011.y`, Invest2012 = `2012.y`,
         Invest2013 = `2013.y`, Invest2014 = `2014.y`, Invest2015 = `2015.y`,
         Other_abuse = Other.x, Unknown_abuse = Unknown.x, Other_perp = Other.y,
         Unknown_perp = Unknown.y, Perp2011 = `2011`, Perp2012 = `2012`,
         Perp2013 = `2013`, Perp2014 = `2014`, Perp2015 = `2015`, Total_screened = Total) %>%
  select(- `Year.x`, - `Year.y`, - `Table.x`, - `Year.x.x`, - `Table.y`, - `Table.x.x`,
         - `2014.x`, - `2015.x`, - `Table.y.y`, - `Year.y.y`, - `Table.x.x.x`, - `Format.x`,
         - `Year.x.x.x`, - `Table.y.y.y`, - `Table.x.x.x.x`, - `Year.y.y.y`, - `Table.y.y.y.y`,
         - `Year`, - `Table`, - `Format.y`, - `Rate2014`)

All_data[is.na(All_data)] = 0

All_data <- 
  All_data[-c(38, 52, 53), ]

All_data <- 
  All_data %>%
  mutate(State_num = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
                       19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
                       35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50))
  
```
Here we have joined all the relevant tables together to make one big data table for analysis. 


# Data Visualization 

## Graph 1 

```{r}
# Layered graph
Graph_1 <- 
  ggplot() +
  geom_line(data = All_data, aes(State_num, Num_fatalities2014, color = "Num_fatalities2014")) +
  geom_point(data = fed_data, aes(State_num, Rate_per_100000, color = "Rate_per_100000"))

plot(Graph_1)
  
  
```

## Graph 2

```{r}
# Multiple variables graph 
Graph_2 <- 
  All_data %>%
  ggplot() +
  geom_point(aes(x = State_num, y = Num_fatalities2011, color = "Num_fatalities2011")) +
  geom_point(aes(x = State_num, y = Num_fatalities2012, color = "Num_fatalities2012")) +
  geom_point(aes(x = State_num, y = Num_fatalities2013, color = "Num_fatalities2013")) +
  geom_point(aes(x = State_num, y = Num_fatalities2014, color = "Num_fatalities2014")) +
  geom_point(aes(x = State_num, y = Num_fatalities2015, color = "Num_fatalities2015")) + 
  ggtitle("Number of Child Abuse Fatalities From 2011 To 2015") +
  xlab("Number Corresponding To State From Table") +
  ylab("Number of Child Abuse Fatalities")

plot(Graph_2)

```

## Graph 3 

```{r}
# Multiple variables graph
Graph_3 <- 
  All_data %>%
  ggplot() +
  geom_line(aes(State_num, Invest2011, color = "Invest2011")) +
  geom_line(aes(State_num, Invest2012, color = "Invest2012")) +
  geom_line(aes(State_num, Invest2013, color = "Invest2013")) +
  geom_line(aes(State_num, Invest2014, color = "Invest2014")) +
  geom_line(aes(State_num, Invest2015, color = "Invest2015")) + 
  ggtitle("Number of Investigations From 2011 To 2015") +
  xlab("Number Corresponding To State From Table") +
  ylab("Number of Investigations")

plot(Graph_3)

```

## Graph 4

```{r}
# Multiple variables graph
Graph_4 <- 
  All_data %>%
  ggplot() +
  geom_area(aes(State_num, Med_neglect, color = "Med_neglect")) +
  geom_area(aes(State_num, Neglect, color = "Neglect")) +
  geom_area(aes(State_num, Other_abuse, color = "Other_abuse")) +
  geom_area(aes(State_num, Physical_abuse, color = "Physical_abuse")) +
  geom_area(aes(State_num, Psych_abuse, color = "Psych_abuse")) + 
  geom_area(aes(State_num, Sexual_abuse, color = "Sexual_abuse")) +
  geom_area(aes(State_num, Unknown_abuse, color = "Unknown_abuse")) +
  ggtitle("Types of Abuse") +
  xlab("Number Corresponding To State From Table") +
  ylab("Number of Victims That Suffered")

plot(Graph_4)


```

# Article on Child Abuse 

https://www.nspcc.org.uk/what-we-do/childrens-stories-about-abuse/ 

This website provides different childs' abuse stories. I have a collection of 5 abuse stories compiled into a word document

```{r}

Stories <- 
  read.delim("Child abuse stories.txt", header = FALSE, fill = TRUE)

str(Stories)
```  

```{r}

Stories  <-
  Stories$V1 %>%
  gsub(pattern = "\\<", replacement = "")

```




# This is what is left to do:

So, I am terrible at coding. Let me know if it is okay if you work on coding the stuff below that is left. I tried to do my best with what I could. I have ideas for each, I just dont know how to write the code. If you do a lot of the coding, I can take care of explaing everything, narrarating, and the guidance document. Thanks! Also, if you can't figure the rest of the stuff out, or feel like I should do more work, let me know! just shoot me a text when you are done working and I'll go through and narrate and all that jazz. 

## Data Wrangling Portion
* Use of regular expressions 
    + Trying to import article on abuse
* User-defined functions    
    + See if you can find a way to create a function to remove even rows, For example lines 99 and any others with this same issue
* Loops and/or control flow     
    + Use loop in function?

## Data Visualization

Can you check my graphs to make sure they meet the requirements please ?


## Data Analysis

* Statistical modeling/Supervised learning
* Unsupervised learning
* Analysis of text data
test


















